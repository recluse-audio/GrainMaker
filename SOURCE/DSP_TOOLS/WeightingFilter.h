#pragma once
#include <cmath>
#include <cassert>
#include "BiquadFilter.h"

/*
 
 A-weighting (TODO)
 
 coeffs44 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -0.140536082420711   0.004937597615540
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.884901217428792   0.886421471816167
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.994138881266328   0.994147469444531


 coeffs48 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -0.224558458059779   0.012606625271546
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.893870494723070   0.895159769094661
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.994614455993022   0.994621707014084


 coeffs88 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -0.788728610908997   0.155523205416609
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.941142662727710   0.941533948268554
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.997067292014450   0.997069442208482


 coeffs96 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -0.859073102837477   0.184501649004703
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.945824527367811   0.946155603519763
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.997305414020089   0.997307229218489


 coeffs176 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -1.286304426932267   0.413644769686387
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.970231862410663   0.970331142204023
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.998533108261586   0.998533646204429


 coeffs192 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -1.334646603086623   0.445320388782665
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.972624833530474   0.972708737212715
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.998652253057543   0.998652707162998

 */

/*
 
 C-weighting (TODO)
 
 coeffs44 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -0.140536082420711   0.004937597615540
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.994138881266328   0.994147469444531


 coeffs48 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -0.224558458059779   0.012606625271546
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.994614455993022   0.994621707014084


 coeffs88 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -0.788728610908997   0.155523205416609
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.997067292014450   0.997069442208482


 coeffs96 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -0.859073102837477   0.184501649004703
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.997305414020089   0.997307229218489


 coeffs176 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -1.286304426932267   0.413644769686387
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.998533108261586   0.998533646204429


 coeffs192 =

    1.000000000000000   2.000000000000000   1.000000000000000   1.000000000000000  -1.334646603086623   0.445320388782665
    1.000000000000000  -2.000000000000000   1.000000000000000   1.000000000000000  -1.998652253057543   0.998652707162998

 */

template <typename dspfloat_t>
class WeightingFilter
{
public:
    enum Type {
        KWeighting = 0,
        AWeighting, // TODO
        CWeighting  // TODO
    };

    WeightingFilter() {}
    ~WeightingFilter() {}

    void setType(int type)
    {
        type = KWeighting;
        prepare(SR);
    }

    void prepare(float sr)
    {

        // determine index into coefficient array
 
        const float sampleRates[6] = {44100, 48000, 88200, 96000, 176400, 192000};

        int index = 0;
        while (sr > sampleRates[index])
            index++;
        
        assert(index < 6);

        // K-weighting filter coefficients, generated from MATLAB weightingFilter

        const BiquadStruct<double> biquadCoeffs[6][3] =
        {
            // 44.1 KHz
            {
                {{1.530841230050348, -2.650979995154729, 1.169079079921587}, {1.000000000000000, -1.663655113256020, 0.712595428073225}},
                {{0.999560064542514, -1.999120129085029, 0.999560064542514}, {1.000000000000000, -1.989169673629796, 0.989199035787039}},
                {{1.000000000000000,  0.000000000000000, 0.000000000000000}, {1.000000000000000,  0.000000000000000, 0.000000000000000}}
            },

            // 48 KHz
            {
                {{1.535124859586970, -2.691696189406380, 1.198392810852850}, {1.000000000000000, -1.690659293182410, 0.732480774215850}},
                {{1.000000000000000, -2.000000000000000, 1.000000000000000}, {1.000000000000000, -1.990047454833980, 0.990072250366210}},
                {{1.000000000000000,  0.000000000000000, 0.000000000000000}, {1.000000000000000,  0.000000000000000, 0.000000000000000}}
            },

            // 88.2 KHz
            {
                {{1.557515375579654, -2.905627079926345, 1.361333977472212}, {1.000000000000000, -1.830919987962332, 0.844142261087853}},
                {{1.002271963357382, -2.004543926714764, 1.002271963357382}, {1.000000000000000, -1.994577515450344, 0.994584875878055}},
                {{1.000000000000000,  0.000000000000000, 0.000000000000000}, {1.000000000000000,  0.000000000000000, 0.000000000000000}}
            },

            // 96 KHz
            {
                {{1.559714228975796, -2.926741578251082, 1.378261202315819}, {1.000000000000000, -1.844609469890109, 0.855843322930641}},
                {{1.002492788986343, -2.004985577972686, 1.002492788986343}, {1.000000000000000, -1.995017544724716, 0.995023759040923}},
                {{1.000000000000000,  0.000000000000000, 0.000000000000000}, {1.000000000000000,  0.000000000000000, 0.000000000000000}}
            },

            // 176.4 KHz
            {
                {{1.571115317741846, -3.036544502404652, 1.468871611989762}, {1.000000000000000, -1.915329316833052, 0.918771744160008}},
                {{1.003632047104213, -2.007264094208426, 1.003632047104213}, {1.000000000000000, -1.997286922423814, 0.997288765026068}},
                {{1.000000000000000,  0.000000000000000, 0.000000000000000}, {1.000000000000000,  0.000000000000000, 0.000000000000000}}
            },

            // 192 KHz
            {
                {{1.572227215091279, -3.047283051561551, 1.477971340979609}, {1.000000000000000, -1.922202230607489, 0.925117735116826}},
                {{1.003742675371436, -2.007485350742872, 1.003742675371436}, {1.000000000000000, -1.997507222840700, 0.997508778355510}},
                {{1.000000000000000,  0.000000000000000, 0.000000000000000}, {1.000000000000000,  0.000000000000000, 0.000000000000000}}
            }
        };

        // design biquads
        
        bqf[0].design(biquadCoeffs[index][0]);
        bqf[1].design(biquadCoeffs[index][1]);
        bqf[2].design(biquadCoeffs[index][2]);
    }

    // process mono
    inline dspfloat_t run(dspfloat_t xin)
    {
        dspfloat_t x = xin;
        
        // run stage 1
        x = bqf[0].run(x);
        // run stage 2
        x = bqf[1].run(x);
        // run stage 3
        x = bqf[2].run(x);
        
        return x;
    }
    
    // process stereo
    inline void run(dspfloat_t ( &xi )[2], dspfloat_t ( &xo )[2], bool stereo = false)
    {
        dspfloat_t x[2] = {0, 0};
        
        x[0] = xi[0];
        if (stereo)
            x[1] = xi[1];
        
        // run stage 1
        bqf[0].run(x, x, stereo);
        // run stage 2
        bqf[1].run(x, x, stereo);
        // run stage 3
        bqf[2].run(x, x, stereo);
        
        xo[0] = x[0];
        if (stereo)
            xo[1] = x[1];
    }
    
private:

    int weightingType = KWeighting;
    float SR = 44100; // sample rate

    // weighting filters

    BiquadFilter<double> bqf[3]; // 3 stages

};
